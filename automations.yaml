 # This automation script runs when a value is received via MQTT on retained topic: setTemperature
 # It sets the value slider on the GUI. This slides also had its own automation when the value is changed.
- alias: Set kitchen left shutter slider
  hide_entity: True
  initial_state: True
  trigger:
    platform: mqtt
    topic: "catingham_palace/kitchen/left_rolling_shutter/position"
   # entity_id: input_number.target_temp
  action:
     service: input_number.set_value
     data_template:
      entity_id: input_number.kitchen_left_rolling_shutter
      value: '{{ trigger.payload }}'

 # This automation script runs when the target temperature slider is moved.
 # It publishes its value to the same MQTT topic it is also subscribed to.
- alias: Kitchen left shutter slider moved
  hide_entity: True
  initial_state: True
  trigger:
    platform: state
    entity_id: input_number.kitchen_left_rolling_shutter
  action:
    service: mqtt.publish
    data_template:
      topic: "catingham_palace/kitchen/left_rolling_shutter/position/set"
      retain: true
      payload: '{{ states.input_number.kitchen_left_rolling_shutter.state | int }}'

- alias: Set kitchen right shutter slider
  hide_entity: True
  initial_state: True
  trigger:
    platform: mqtt
    topic: "catingham_palace/kitchen/right_rolling_shutter/position"
  action:
     service: input_number.set_value
     data_template:
      entity_id: input_number.kitchen_right_rolling_shutter
      value: '{{ trigger.payload }}'


- alias: Roller shutters with balcony slider moved
  hide_entity: True
  initial_state: True
  trigger:
    - platform: state
      entity_id: input_number.kitchen_right_rolling_shutter
    - platform: state  
      entity_id: input_number.green_room_rolling_shutter
    - platform: state
      entity_id: input_number.living_room_right_rolling_shutter
    - platform: state  
      entity_id: input_number.bedroom_rolling_shutter  
  action:
    service: mqtt.publish
    data_template:
      topic: >-
        {%- set domain, device = trigger.entity_id.split('.') -%}
        {%- set location = (device | regex_replace("_((left|right)_)?rolling_shutter$",'')) -%}
        {%- set sensor_name = device.replace(location,"")[1:] -%}
        catingham_palace/{{location}}/{{sensor_name}}/position/set
      retain: true
      payload: >-
        {%- set domain, device = trigger.entity_id.split('.') -%}
        {%- set location = (device | regex_replace("_((left|right)_)?rolling_shutter$",'')) -%}
        {%- if is_state(("automation.leave_cat_passage_" ~ location),"on") -%}
        {{ (trigger.to_state.state | int, states.input_number.cat_passage.state | int) | max }}
        {%- else -%}
        {{ trigger.to_state.state | int }}
        {%- endif -%}


- alias: Set green room shutter slider
  hide_entity: True
  initial_state: True
  trigger:
    platform: mqtt
    topic: "catingham_palace/green_room/rolling_shutter/position"
  action:
     service: input_number.set_value
     data_template:
      entity_id: input_number.green_room_rolling_shutter
      value: '{{ trigger.payload }}'

- alias: Set pink room shutter slider
  hide_entity: True
  initial_state: True
  trigger:
    platform: mqtt
    topic: "catingham_palace/pink_room/rolling_shutter/position"
  action:
     service: input_number.set_value
     data_template:
      entity_id: input_number.pink_room_rolling_shutter
      value: '{{ trigger.payload }}'

- alias: Pink room shutter slider moved
  hide_entity: True
  initial_state: True
  trigger:
    platform: state
    entity_id: input_number.pink_room_rolling_shutter
  action:
    service: mqtt.publish
    data_template:
      topic: "catingham_palace/pink_room/rolling_shutter/position/set"
      retain: true
      payload: '{{ states.input_number.pink_room_rolling_shutter.state | int }}'

- alias: Set bedroom shutter slider
  hide_entity: True
  initial_state: True
  trigger:
    platform: mqtt
    topic: "catingham_palace/bedroom/rolling_shutter/position"
  action:
     service: input_number.set_value
     data_template:
      entity_id: input_number.bedroom_rolling_shutter
      value: '{{ trigger.payload }}'


- alias: Set bathroom shutter slider
  hide_entity: True
  initial_state: True
  trigger:
    platform: mqtt
    topic: "catingham_palace/bathroom/rolling_shutter/position"
  action:
     service: input_number.set_value
     data_template:
      entity_id: input_number.bathroom_rolling_shutter
      value: '{{ trigger.payload }}'

- alias: Bathroom shutter slider moved
  hide_entity: True
  initial_state: True
  trigger:
    platform: state
    entity_id: input_number.bathroom_rolling_shutter
  action:
    service: mqtt.publish
    data_template:
      topic: "catingham_palace/bathroom/rolling_shutter/position/set"
      retain: true
      payload: '{{ states.input_number.bathroom_rolling_shutter.state | int }}'

- alias: Set living room left shutter slider
  hide_entity: True
  initial_state: True
  trigger:
    platform: mqtt
    topic: "catingham_palace/living_room/left_rolling_shutter/position"
  action:
     service: input_number.set_value
     data_template:
      entity_id: input_number.living_room_left_rolling_shutter
      value: '{{ trigger.payload }}'

- alias: Living room left shutter slider moved
  hide_entity: True
  initial_state: True
  trigger:
    platform: state
    entity_id: input_number.living_room_left_rolling_shutter
  action:
    service: mqtt.publish
    data_template:
      topic: "catingham_palace/living_room/left_rolling_shutter/position/set"
      retain: true
      payload: '{{ states.input_number.living_room_left_rolling_shutter.state | int }}'


- alias: Set living room right shutter slider
  hide_entity: True
  initial_state: True
  trigger:
    platform: mqtt
    topic: "catingham_palace/living_room/right_rolling_shutter/position"
  action:
     service: input_number.set_value
     data_template:
      entity_id: input_number.living_room_right_rolling_shutter
      value: '{{ trigger.payload }}'


- id: 'leave_cat_passage_living_room'
  alias: 'Leave cat passage living room'
  initial_state: False
  trigger:
    - platform: state
      entity_id: automation.leave_cat_passage_living_room
      to: 'on'
    #- platform: numeric_state
    #  entity_id: input_number.living_room_right_rolling_shutter
    #  below: '{{ float(states.input_number.cat_passage.state) }}'
    - platform: template
      value_template: "{{ float(states.input_number.living_room_right_rolling_shutter.state) < float(states.input_number.cat_passage.state) }}"
  condition:
    #condition: numeric_state
    #entity_id: input_number.living_room_right_rolling_shutter
    #below: '{{ float(states.input_number.cat_passage.state) }}'
    condition: template
    value_template: "{{ float(states.input_number.living_room_right_rolling_shutter.state) < float(states.input_number.cat_passage.state) }}"
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.living_room_right_rolling_shutter
        #value: 95
        value: '{{ (states.input_number.cat_passage.state | int) }}'

- id: 'leave_cat_passage_kitchen'
  alias: 'Leave cat passage kitchen'
  initial_state: False
  trigger:
    - platform: state
      entity_id: automation.leave_cat_passage_kitchen
      to: 'on'
    - platform: template
      value_template: "{{ float(states.input_number.kitchen_right_rolling_shutter.state) < float(states.input_number.cat_passage.state) }}"
  condition:
    condition: template
    value_template: "{{ float(states.input_number.kitchen_right_rolling_shutter.state) < float(states.input_number.cat_passage.state) }}"
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.kitchen_right_rolling_shutter
        value: '{{ (states.input_number.cat_passage.state | int) }}'

- id: 'leave_cat_passage_green_room'
  alias: 'Leave cat passage green room'
  initial_state: False
  trigger:
    - platform: state
      entity_id: automation.leave_cat_passage_green_room
      to: 'on'
    - platform: template
      value_template: "{{ float(states.input_number.green_room_rolling_shutter.state) < float(states.input_number.cat_passage.state) }}"
  condition:
    condition: template
    value_template: "{{ float(states.input_number.green_room_rolling_shutter.state) < float(states.input_number.cat_passage.state) }}"
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.green_room_rolling_shutter
        value: '{{ (states.input_number.cat_passage.state | int) }}'

- id: 'leave_cat_passage_bedroom'
  alias: 'Leave cat passage bedroom'
  initial_state: False
  trigger:
    - platform: state
      entity_id: automation.leave_cat_passage_bedroom
      to: 'on'
    - platform: template
      value_template: "{{ float(states.input_number.bedroom_rolling_shutter.state) < float(states.input_number.cat_passage.state) }}"
  condition:
    condition: template
    value_template: "{{ float(states.input_number.bedroom_rolling_shutter.state) < float(states.input_number.cat_passage.state) }}"
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.bedroom_rolling_shutter
        value: '{{ (states.input_number.cat_passage.state | int) }}'

- alias: 'Telegram bot that reply pong to ping'
  hide_entity: true
  initial_state: True
  trigger:
    platform: event
    event_type: telegram_command
    event_data:
      command: '/ping'
  action:
    - service: notify.catinghampalacebot
      data:
        message: 'pong'

- alias: 'Update Available Notifications'
  hide_entity: True
  initial_state: True
  trigger:
    platform: state
    entity_id: updater.updater
  action:
    - service: notify.telegram2rubens
      data:
        message: 'A new update for Home Assistant is available.'

- id: 'roller_shutter_down_right_living_room'
  alias: "Roller shutter down right living room"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_down_right_living_room
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.living_room_right_rolling_shutter
        value: '{% if is_state("automation.leave_cat_passage_living_room","on") %}{{ (states.input_number.cat_passage.state | int) }}{% else %}0{% endif %}'
    - service: automation.turn_off
      entity_id: automation.roller_shutter_down_right_living_room

- id: 'roller_shutter_up_right_living_room'
  alias: "Roller shutter up right living room"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_up_right_living_room
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.living_room_right_rolling_shutter
        value: 100
    - service: automation.turn_off
      entity_id: automation.roller_shutter_up_right_living_room

- id: 'roller_shutter_down_left_living_room'
  alias: "Roller shutter down left living room"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_down_left_living_room
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.living_room_left_rolling_shutter
        value: 0
    - service: automation.turn_off
      entity_id: automation.roller_shutter_down_left_living_room

- id: 'roller_shutter_up_left_living_room'
  alias: "Roller shutter up left living room"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_up_left_living_room
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.living_room_left_rolling_shutter
        value: 100
    - service: automation.turn_off
      entity_id: automation.roller_shutter_up_left_living_room

- id: 'roller_shutter_down_right_kitchen'
  alias: "Roller shutter down right kitchen"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_down_right_kitchen
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.kitchen_right_rolling_shutter
        value: '{% if is_state("automation.leave_cat_passage_kitchen","on") %}{{ (states.input_number.cat_passage.state | int) }}{% else %}0{% endif %}'
    - service: automation.turn_off
      entity_id: automation.roller_shutter_down_right_kitchen

- id: 'roller_shutter_up_right_kitchen'
  alias: "Roller shutter up right kitchen"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_up_right_kitchen
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.kitchen_right_rolling_shutter
        value: 100
    - service: automation.turn_off
      entity_id: automation.roller_shutter_up_right_kitchen

- id: 'roller_shutter_down_left_kitchen'
  alias: "Roller shutter down left kitchen"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_down_left_kitchen
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.kitchen_left_rolling_shutter
        value: 0
    - service: automation.turn_off
      entity_id: automation.roller_shutter_down_left_kitchen

- id: 'roller_shutter_up_left_kitchen'
  alias: "Roller shutter up left kitchen"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_up_left_kitchen
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.kitchen_left_rolling_shutter
        value: 100
    - service: automation.turn_off
      entity_id: automation.roller_shutter_up_left_kitchen

- id: 'roller_shutter_down_green_room'
  alias: "Roller shutter down green room"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_down_green_room
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.green_room_rolling_shutter
        value: '{% if is_state("automation.leave_cat_passage_green_room","on") %}{{ (states.input_number.cat_passage.state | int) }}{% else %}0{% endif %}'
    - service: automation.turn_off
      entity_id: automation.roller_shutter_down_green_room

- id: 'roller_shutter_up_green_room'
  alias: "Roller shutter up green room"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_up_green_room
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.green_room_rolling_shutter
        value: 100
    - service: automation.turn_off
      entity_id: automation.roller_shutter_up_green_room


- id: 'roller_shutter_down_bedroom'
  alias: "Roller shutter down bedroom"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_down_bedroom
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.bedroom_rolling_shutter
        value: '{% if is_state("automation.leave_cat_passage_bedroom","on") %}{{ (states.input_number.cat_passage.state | int) }}{% else %}0{% endif %}'
    - service: automation.turn_off
      entity_id: automation.roller_shutter_down_bedroom

- id: 'roller_shutter_up_bedroom'
  alias: "Roller shutter up bedroom"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_up_bedroom
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.bedroom_rolling_shutter
        value: 100
    - service: automation.turn_off
      entity_id: automation.roller_shutter_up_bedroom

- id: 'roller_shutter_down_pink_room'
  alias: "Roller shutter down pink room"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_down_pink_room
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.pink_room_rolling_shutter
        value: 0
    - service: automation.turn_off
      entity_id: automation.roller_shutter_down_pink_room

- id: 'roller_shutter_up_pink_room'
  alias: "Roller shutter up pink room"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_up_pink_room
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.pink_room_rolling_shutter
        value: 100
    - service: automation.turn_off
      entity_id: automation.roller_shutter_up_pink_room

- id: 'roller_shutter_down_bathroom'
  alias: "Roller shutter down bathroom"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_down_bathroom
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.bathroom_rolling_shutter
        value: 0
    - service: automation.turn_off
      entity_id: automation.roller_shutter_down_bathroom

- id: 'roller_shutter_up_bathroom'
  alias: "Roller shutter up bathroom"
  initial_state: False
  hide_entity: True
  trigger:
   - platform: state
     entity_id: automation.roller_shutter_up_bathroom
     to: 'on'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.bathroom_rolling_shutter
        value: 100
    - service: automation.turn_off
      entity_id: automation.roller_shutter_up_bathroom

- id: 'weekend_roller_shutter_up'
  alias: "Weekend roller shutter up"
  initial_state: False
  trigger:
   - platform: state
     entity_id: automation.weekend_roller_shutter_up
     to: 'on'
  action:
    - service: automation.turn_on
      entity_id: automation.roller_shutter_up_left_living_room
#    - service: automation.turn_on
#      entity_id: automation.roller_shutter_up_right_living_room
    - service: automation.turn_on
      entity_id: automation.roller_shutter_up_left_kitchen
#    - service: automation.turn_on
#      entity_id: automation.roller_shutter_up_right_kitchen
    - service: automation.turn_on
      entity_id: automation.roller_shutter_up_green_room
    - service: automation.turn_on
      entity_id: automation.roller_shutter_up_pink_room
    - service: automation.turn_on
      entity_id: automation.roller_shutter_up_bathroom
    - service: input_select.select_option
      data:
        entity_id: input_select.roller_shutters_scene
        option: "day"      
    - service: automation.turn_off
      entity_id: automation.weekend_roller_shutter_up

- id: 'all_roller_shutter_up'
  alias: "All roller shutter up"
  initial_state: False
  trigger:
   - platform: state
     entity_id: automation.all_roller_shutter_up
     to: 'on'
  action:
    - service: automation.turn_on
      entity_id: automation.weekend_roller_shutter_up
    - service: automation.turn_on
      entity_id: automation.roller_shutter_up_bedroom
    - service: automation.turn_off
      entity_id: automation.all_roller_shutter_up
    

- id: 'all_roller_shutter_down'
  alias: "All roller shutter down"
  initial_state: False
  trigger:
   - platform: state
     entity_id: automation.all_roller_shutter_down
     to: 'on'
  action:
    - service: automation.turn_on
      entity_id: automation.roller_shutter_down_left_living_room
    - service: automation.turn_on
      entity_id: automation.roller_shutter_down_right_living_room
    - service: automation.turn_on
      entity_id: automation.roller_shutter_down_left_kitchen
    - service: automation.turn_on
      entity_id: automation.roller_shutter_down_right_kitchen
    - service: automation.turn_on
      entity_id: automation.roller_shutter_down_green_room
    - service: automation.turn_on
      entity_id: automation.roller_shutter_down_bedroom
    - service: automation.turn_on
      entity_id: automation.roller_shutter_down_pink_room
    - service: automation.turn_on
      entity_id: automation.roller_shutter_down_bathroom
    - service: input_select.select_option
      data:
        entity_id: input_select.roller_shutters_scene
        option: "night"      
    - service: automation.turn_off
      entity_id: automation.all_roller_shutter_down

- id: 'roller_shutter_sunrise'
  alias: 'Roller shutter sunrise'
  initial_state: True
  trigger:
    - platform: sun
      event: sunrise
      offset: "-00:30:00"
    - platform: time
      at: "06:00:00"
  condition:  
    condition: and
    conditions:
      - condition: sun
        after: sunrise
        after_offset: "-00:30:00"
      - condition: time
        after: "06:00:00"    
  action: 
    - service: automation.turn_on
      entity_id: automation.weekend_roller_shutter_up
  #  - condition: or
  #    conditions:
  #      - condition: time
  #        weekday:
  #          - mon
  #          - tue
  #          - wed
  #          - thu
  #          - fri
  #      - condition: state
  #        entity_id: 'input_boolean.avoid_bedroom_roller_shutter_up_during_weekend'
  #        state: 'off'
  #  - service: automation.turn_on
  #    entity_id: automation.roller_shutter_up_bedroom

- id: 'roller_shutter_sunset'
  alias: 'Roller shutter sunset'
  initial_state: True
  trigger:
    platform: sun
    event: sunset
#    offset: "00:30:00"
  action: 
    service: automation.turn_on
    entity_id: automation.all_roller_shutter_down

- id: "notify_homeassistant_startup"
  alias: "Notify HomeAssistant startup"
  initial_state: True
  trigger:
    - platform: homeassistant
      event: start
  action:
    - service: notify.telegram2rubens
      data: 
        message: "HomeAssistant started"  

- id: 'living_room_auto_cat_passage_on_window_change'
  alias: 'Living room automatic cat passage on window state'
  initial_state: True
  trigger:
    - platform: state
      entity_id: binary_sensor.living_room_right_window
    - platform: state
      entity_id: switch.automatic_cat_passage
      to: 'on'
    - platform: homeassistant
      event: start  
  condition:    
    condition: state
    entity_id: switch.automatic_cat_passage
    state: 'on'
  action:
    - service_template: >
        {% if is_state('binary_sensor.living_room_right_window', 'on') %}
          automation.turn_on
        {% else %}
          automation.turn_off
        {% endif %}
      entity_id: automation.leave_cat_passage_living_room 

- id: 'kitchen_auto_cat_passage_on_window_change'
  alias: 'Kitchen automatic cat passage on window state'
  initial_state: True
  trigger:
    - platform: state
      entity_id: binary_sensor.kitchen_right_window
    - platform: state
      entity_id: switch.automatic_cat_passage
      to: 'on'
    - platform: homeassistant
      event: start        
  condition:    
    condition: state
    entity_id: switch.automatic_cat_passage
    state: 'on'
  action:
    - service_template: >
        {% if is_state('binary_sensor.kitchen_right_window', 'on') %}
          automation.turn_on
        {% else %}
          automation.turn_off
        {% endif %}
      entity_id: automation.leave_cat_passage_kitchen 

- id: 'bedroom_auto_cat_passage_on_window_change'
  alias: 'Bedroom automatic cat passage on window state'
  initial_state: True
  trigger:
    - platform: state
      entity_id: binary_sensor.bedroom_window
    - platform: state
      entity_id: switch.automatic_cat_passage
      to: 'on'
    - platform: homeassistant
      event: start        
  condition:    
    condition: state
    entity_id: switch.automatic_cat_passage
    state: 'on'
  action:
    - service_template: >
        {% if is_state('binary_sensor.bedroom_window', 'on') %}
          automation.turn_on
        {% else %}
          automation.turn_off
        {% endif %}
      entity_id: automation.leave_cat_passage_bedroom 

- id: 'green_room_auto_cat_passage_on_window_change'
  alias: 'Green room automatic cat passage on window state'
  initial_state: True
  trigger:
    - platform: state
      entity_id: binary_sensor.green_room_window
    - platform: state
      entity_id: switch.automatic_cat_passage
      to: 'on'
    - platform: homeassistant
      event: start        
  condition:    
    condition: state
    entity_id: switch.automatic_cat_passage
    state: 'on'
  action:
    - service_template: >
        {% if is_state('binary_sensor.green_room_window', 'on') %}
          automation.turn_on
        {% else %}
          automation.turn_off
        {% endif %}
      entity_id: automation.leave_cat_passage_green_room 


- id: 'greenhouse_auto_humidity_power_off'
  alias: 'Greenhouse auto humidity power off'
  initial_state: True
  trigger:
    - platform: template
      value_template: '{% if (states("sensor.greenhouse_humidity")| int > (states("input_number.greenhouse_humidifier_target_humidity")|int) + 3) %}true{% endif %}'
  condition:    
    condition: state
    entity_id: switch.greenhouse_humidifier_mode
    state: 'on'      
  action:
    - service: switch.turn_off
      entity_id: switch.greenhouse_humidifier_power
 
- id: 'greenhouse_auto_humidity_power_on'
  alias: 'Greenhouse auto humidity power on'
  initial_state: True
  trigger:
    - platform: template
      value_template: '{% if (states("sensor.greenhouse_humidity")| int < (states("input_number.greenhouse_humidifier_target_humidity")|int) - 3) %}true{% endif %}'
  condition:    
    condition: state
    entity_id: switch.greenhouse_humidifier_mode
    state: 'on'      
  action:
    - service: switch.turn_on
      entity_id: switch.greenhouse_humidifier_power
      
- id: 'living_room_roller_shutter_up_delayed'
  alias: 'Living room roller shutter up delayed'
  initial_state: True
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.tv_shut_down_delay
  action:
    - service: automation.turn_on
      entity_id: automation.roller_shutter_up_left_living_room
      
- id: 'living_room_roller_shutter_tv_on_aware'
  alias: 'Living room roller shutter TV ON aware'
  initial_state: True
  trigger:
    - platform: state
      entity_id: media_player.living_room_tv
      to: 'on'
  condition: 
    condition: state
    entity_id: input_select.roller_shutters_scene
    state: 'day'
  action:
    - service: timer.cancel
      entity_id: timer.tv_shut_down_delay
    - service: automation.turn_on
      entity_id: automation.roller_shutter_down_left_living_room
      

- id: 'living_room_roller_shutter_tv_off_aware'
  alias: 'Living room roller shutter TV OFF aware'
  initial_state: True
  trigger:
    - platform: state
      entity_id: media_player.living_room_tv
      to: 'off'    
  condition: 
    condition: state
    entity_id: input_select.roller_shutters_scene
    state: 'day'
  action:
    - service: timer.start
      entity_id: timer.tv_shut_down_delay
